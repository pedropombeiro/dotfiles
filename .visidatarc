#!/usr/bin/env python

import datetime  # Allow additional datetime column formats

import dateutil

options.motd_url = ""

options.color_active_status = "black on 234"
options.color_bottom_hdr = "underline white"
options.color_cmdpalette = "white on 234"
options.color_current_cell = "16 on white"
options.color_current_col = ""
options.color_current_row = "bold on 240"
options.color_default = "255 on black"
options.color_current_hdr = "bold white on black"
options.color_heading = "black on white"
options.color_key_col = "cyan"
options.color_keystrokes = "green"
options.color_longname_guide = "green"
options.color_menu = "white on 234"
options.color_menu_active = "white on black"
options.color_menu_help = "white on black"
options.color_menu_spec = "bold on 240"
options.color_sidebar = "white on black"
options.color_sidebar_title = "black on 255 white"


def agg_range(values):
    # Filter out invalid or incompatible values
    valid = []
    for v in values:
        if v is None:
            continue
            # ignore arrays like [1] value
            if isinstance(v, (list, tuple, dict)):
                continue
            valid.append(v)

    if not valid:
        return None

    try:
        diff = max(valid) - min(valid)
        return diff
    except Exception:
        return None


def agg_non_empty(values):
    return sum(1 for v in values if v is not None and v != "")


vd.aggregator("range", agg_range, "returns (max - min)", type=float)
vd.aggregator("non_empty", agg_non_empty, "returns non empty values")


################################################################################
# autotune.py
# https://gist.github.com/cool-RR/47d8ebb7afc636a995fccf889aada8e9

N_ROWS_FOR_TYPE_GUESSING = 100
DEFAULT_FLOAT_PRECISION = 5
DATE_FORMATS = [
    "%Y-%m-%dT%H:%M:%S.%f%z",
    "%Y-%m-%dT%H:%M:%S%z",
    "%Y-%m-%dT%H:%M:%S.%f",
    "%Y-%m-%d %H:%M:%S.%f",
    "%Y-%m-%d %H:%M:%S",
    "%Y-%m-%d",
]


@GraphSheet.api
def guess_y_axis(graph_sheet: GraphSheet) -> None:
    values = tuple(
        column.getTypedValue(row)
        for column in graph_sheet.ycols
        for row in column.sheet.rows
    )
    min_value = min(values)
    max_value = max(values)
    if 0 <= min_value <= max_value <= 1:
        graph_sheet.set_y("-0.1 1.1")
        graph_sheet.extra_y_ticks = (0, 1)
    elif -1 <= min_value <= max_value <= 1:
        graph_sheet.set_y("-1.1 1.1")
        graph_sheet.extra_y_ticks = (-1, 1)


def guess_column_types(sheet: BaseSheet) -> None:
    if isinstance(sheet, DirSheet):
        # These break for some reason.
        return

    for column in sheet.visibleCols:
        if column.type not in (anytype, int):
            continue

        type_candidates = [int, float, date, anytype]
        try:
            values = tuple(
                column.getValue(r) for r in sheet.rows[:N_ROWS_FOR_TYPE_GUESSING]
            )
        except Exception:
            # I got an inexplicable `NameError` here while doing this on a `DirSheet`, so let's not
            # guess a column when that happens.
            continue

        for value in values:
            if value is None or value == "":
                continue

            if date in type_candidates:
                if value is int or value is float:
                    type_candidates.remove(date)
                else:
                    found = False
                    for datefmt in DATE_FORMATS:
                        try:
                            datetime.datetime.strptime(value, datefmt)
                            column.fmtstr = datefmt
                            found = True
                            break
                        except ValueError:
                            pass
                    if not found:
                        try:
                            date(value)
                        except dateutil.parser.ParserError:
                            type_candidates.remove(date)

            if int in type_candidates:
                try:
                    value_as_int = int(value)
                except (ValueError, TypeError):
                    type_candidates.remove(int)
                else:
                    if float(value) != value_as_int:
                        type_candidates.remove(int)

            if float in type_candidates:
                try:
                    float(value)
                except (ValueError, TypeError):
                    type_candidates.remove(float)

        column.type = type_candidates[0]

        if column.type is float:
            numbers = tuple(
                column.getTypedValue(r) for r in sheet.rows[:N_ROWS_FOR_TYPE_GUESSING]
            )
            biggest_number = max(map(abs, numbers))
            if biggest_number > 0:
                for i in range(2, 6):
                    if 10 ** (-(i - 1)) < biggest_number:
                        if i != DEFAULT_FLOAT_PRECISION:
                            column.fmtstr = f"%.{i}f"
                        break


def guess_key_columns(sheet: BaseSheet) -> None:
    if sheet.columns and sheet.columns[0].name in (
        "generation",
        "i_agent",
        "time_step",
    ):
        sheet.setKeys([sheet.columns[0]])


@BaseSheet.api
def autotune(sheet: BaseSheet) -> None:
    if isinstance(sheet, GraphSheet):
        guess_y_axis(sheet)
        # Put selection box outside the plot:
        sheet.cursorBox.xmin = sheet.visibleBox.xmin - 8 * sheet.cursorBox.w
    else:
        visidata.features.expand_cols.expand_cols_deep(
            sheet, sheet.visibleCols, depth=0
        )

        guess_column_types(sheet)
        guess_key_columns(sheet)

@BaseSheet.api
def autowidth(sheet: BaseSheet) -> None:
    for column in sheet.visibleCols:
        column: Column
        if column.type is anytype:
            try:
                first_value = column.getValue(sheet.rows[0])
            except Exception:
                # I got an inexplicable `NameError` here while doing this on a `DirSheet`,
                # so let's not guess a column when that happens.
                continue
            if isinstance(first_value, dict):
                column.setWidth(len(column.name) + 5)
                continue
        column.setWidth(column.getMaxWidth(sheet.visibleRows))


BaseSheet.addCommand("b", "autotune", "autotune()")
BaseSheet.addCommand("Alt+=", "autowidth", "autowidth()")
